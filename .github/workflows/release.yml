name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version to bump the release by.
        required: true
        default: minor
        type: choice
        options:
          - major
          - minor
          - patch

      app-name:
        description: The name of the app in the monorepo to create a release PR for
        required: true
        default: ojl-tracker
        type: choice
        options:
          - app-a
          - app-b

jobs:
  get_commits_by_app:
    runs-on: ubuntu-latest
    name: Get Commits by App
    outputs:
      filtered_commits: ${{ steps.filter-commits.outputs.filtered_commits }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Last Git Tag Prefixed with App Name
        id: extract-last-tag
        run: |
          APP_NAME=${{ inputs.app-name }}
          # Get the last tag prefixed with the app name
          LAST_TAG=$(git tag --list "${APP_NAME}*" | sort -V | tail -n 1)

          # If no app-specific tag exists, fall back to the last tag in the repository
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG=$(git tag --list | sort -V | tail -n 1)
          fi

          echo "Last tag for $APP_NAME: $LAST_TAG"
          echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT

      - name: Filter Commits by App
        id: filter-commits
        if: steps.extract-last-tag.outputs.last_tag != ''
        run: |
          LAST_TAG=${{ steps.extract-last-tag.outputs.last_tag }}
          APP_NAME=${{ inputs.app-name }}

          # Extract commits between the last tag and HEAD
          COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s")
          echo "Commits since last tag $LAST_TAG: $COMMITS"

          # Filter commits where the scope matches the app name
          FILTERED_COMMITS=$(echo "$COMMITS" | grep -E "^.+\\(${APP_NAME}\\):" || true)

          # Output filtered commits
          if [ -z "$FILTERED_COMMITS" ]; then
            echo "No commits found for $APP_NAME since last tag."
          else
            echo "Filtered commits: $FILTERED_COMMITS"
          fi
          echo "filtered_commits=$FILTERED_COMMITS" >> $GITHUB_OUTPUT
  
  create_release_pr:
    runs-on: ubuntu-latest
    name: Create Release PR
    needs: get_commits_by_app
    if: needs.get_commits_by_app.outputs.filtered_commits != ''

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        run: |
          APP_NAME=${{ inputs.app-name }}
          CHANGELOG_PATH="apps/${APP_NAME}/CHANGELOG.md"

          # Create the changelog file if it doesn't exist
          if [ ! -f "$CHANGELOG_PATH" ]; then
            echo "Creating CHANGELOG.md for $APP_NAME..."
            echo "# Changelog for $APP_NAME" > "$CHANGELOG_PATH"
          fi

          # Write filtered commits to the changelog file
          npx conventional-changelog -i "$CHANGELOG_PATH" -s --commit-path "apps/${APP_NAME}" --from "$LAST_TAG"

          # Format the changelog using Prettier
          npx prettier --write "$CHANGELOG_PATH"

          # Configure Git user identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Commit the updated changelog
          git add "$CHANGELOG_PATH"
          git commit -m "chore(${APP_NAME}): update changelog"

      - name: Bump the Version
        id: bump-version
        run: |
          new_version_number=$(npm version ${{ inputs.version }} -w ${{ inputs.app-name }} | grep -oP 'v\d+\.\d+\.\d+')
          echo "new_version_number=${new_version_number}" >> $GITHUB_OUTPUT

          # Configure Git user identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Commit the version bump
          git add "apps/${{ inputs.app-name }}/package.json"
          git commit -m "chore(${APP_NAME}): bump version to ${new_version_number}"

      - name: Push Changes
        run: |
          git checkout -b release/${{ inputs.app-name }}/${{ steps.bump-version.outputs.new_version_number }}
          git push origin release/${{ inputs.app-name }}/${{ steps.bump-version.outputs.new_version_number }} --no-verify

      - name: Create Pull Request
        run: |
          PR_DATA=$(jq -n \
            --arg title "chore: ${{ inputs.app-name }} ${{ steps.bump-version.outputs.new_version_number }} release" \
            --arg head "release/${{ inputs.app-name }}/${{ steps.bump-version.outputs.new_version_number }}" \
            --arg base "main" \
            --arg body "Automated changes by a GitHub Action" \
            '{title: $title, head: $head, base: $base, body: $body}')
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls \
            -d "$PR_DATA"